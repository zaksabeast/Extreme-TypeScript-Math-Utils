import { Test } from "ts-toolbelt";
import type { Add } from "./add";
import type { Sub } from "./sub";
import type { GreaterThanOrEq } from "./greaterThan";
import type { BitOr } from "./bit";
import type { ReverseString, SplitStringIntoChars } from "./string";

type PowerList = [
  1,
  2,
  4,
  8,
  16,
  32,
  64,
  128,
  256,
  512,
  1024,
  2048,
  4096,
  8192,
  16384,
  32768,
  65536,
  131072,
  262144,
  524288,
  1048576,
  2097152,
  4194304,
  8388608,
  16777216,
  33554432,
  67108864,
  134217728,
  268435456,
  536870912,
  1073741824,
  2147483648,
  4294967296,
  8589934592,
  17179869184,
  34359738368,
  68719476736,
  137438953472,
  274877906944,
  549755813888,
  1099511627776,
  2199023255552,
  4398046511104,
  8796093022208,
  17592186044416,
  35184372088832,
  70368744177664,
  140737488355328,
  281474976710656,
  562949953421312,
  1125899906842624,
  2251799813685248,
  4503599627370496,
  9007199254740992,
  18014398509481984,
  36028797018963970,
  72057594037927940,
  144115188075855870,
  288230376151711740,
  576460752303423500,
  1152921504606847000,
  2305843009213694000,
  4611686018427388000,
  9223372036854776000
];

type ExponentToBase2 = [
  "0000000000000000000000000000000000000000000000000000000000000001",
  "0000000000000000000000000000000000000000000000000000000000000010",
  "0000000000000000000000000000000000000000000000000000000000000100",
  "0000000000000000000000000000000000000000000000000000000000001000",
  "0000000000000000000000000000000000000000000000000000000000010000",
  "0000000000000000000000000000000000000000000000000000000000100000",
  "0000000000000000000000000000000000000000000000000000000001000000",
  "0000000000000000000000000000000000000000000000000000000010000000",
  "0000000000000000000000000000000000000000000000000000000100000000",
  "0000000000000000000000000000000000000000000000000000001000000000",
  "0000000000000000000000000000000000000000000000000000010000000000",
  "0000000000000000000000000000000000000000000000000000100000000000",
  "0000000000000000000000000000000000000000000000000001000000000000",
  "0000000000000000000000000000000000000000000000000010000000000000",
  "0000000000000000000000000000000000000000000000000100000000000000",
  "0000000000000000000000000000000000000000000000001000000000000000",
  "0000000000000000000000000000000000000000000000010000000000000000",
  "0000000000000000000000000000000000000000000000100000000000000000",
  "0000000000000000000000000000000000000000000001000000000000000000",
  "0000000000000000000000000000000000000000000010000000000000000000",
  "0000000000000000000000000000000000000000000100000000000000000000",
  "0000000000000000000000000000000000000000001000000000000000000000",
  "0000000000000000000000000000000000000000010000000000000000000000",
  "0000000000000000000000000000000000000000100000000000000000000000",
  "0000000000000000000000000000000000000001000000000000000000000000",
  "0000000000000000000000000000000000000010000000000000000000000000",
  "0000000000000000000000000000000000000100000000000000000000000000",
  "0000000000000000000000000000000000001000000000000000000000000000",
  "0000000000000000000000000000000000010000000000000000000000000000",
  "0000000000000000000000000000000000100000000000000000000000000000",
  "0000000000000000000000000000000001000000000000000000000000000000",
  "0000000000000000000000000000000010000000000000000000000000000000",
  "0000000000000000000000000000000100000000000000000000000000000000",
  "0000000000000000000000000000001000000000000000000000000000000000",
  "0000000000000000000000000000010000000000000000000000000000000000",
  "0000000000000000000000000000100000000000000000000000000000000000",
  "0000000000000000000000000001000000000000000000000000000000000000",
  "0000000000000000000000000010000000000000000000000000000000000000",
  "0000000000000000000000000100000000000000000000000000000000000000",
  "0000000000000000000000001000000000000000000000000000000000000000",
  "0000000000000000000000010000000000000000000000000000000000000000",
  "0000000000000000000000100000000000000000000000000000000000000000",
  "0000000000000000000001000000000000000000000000000000000000000000",
  "0000000000000000000010000000000000000000000000000000000000000000",
  "0000000000000000000100000000000000000000000000000000000000000000",
  "0000000000000000001000000000000000000000000000000000000000000000",
  "0000000000000000010000000000000000000000000000000000000000000000",
  "0000000000000000100000000000000000000000000000000000000000000000",
  "0000000000000001000000000000000000000000000000000000000000000000",
  "0000000000000010000000000000000000000000000000000000000000000000",
  "0000000000000100000000000000000000000000000000000000000000000000",
  "0000000000001000000000000000000000000000000000000000000000000000",
  "0000000000010000000000000000000000000000000000000000000000000000",
  "0000000000100000000000000000000000000000000000000000000000000000",
  "0000000001000000000000000000000000000000000000000000000000000000",
  "0000000010000000000000000000000000000000000000000000000000000000",
  "0000000100000000000000000000000000000000000000000000000000000000",
  "0000001000000000000000000000000000000000000000000000000000000000",
  "0000010000000000000000000000000000000000000000000000000000000000",
  "0000100000000000000000000000000000000000000000000000000000000000",
  "0001000000000000000000000000000000000000000000000000000000000000",
  "0010000000000000000000000000000000000000000000000000000000000000",
  "0100000000000000000000000000000000000000000000000000000000000000",
  "1000000000000000000000000000000000000000000000000000000000000000"
];

type HighestPowerOf2<
  N extends number,
  Index extends number = 0
> = Index extends 64
  ? 63
  : GreaterThanOrEq<PowerList[Index], N> extends true
  ? PowerList[Index] extends N
    ? Index
    : Sub<Index, 1>
  : HighestPowerOf2<N, Add<Index, 1>>;

export type Base10To2<
  Num extends number,
  Acc extends string = "00000000000000000000000000000000"
> = Num extends 0
  ? Acc
  : Base10To2<
      Sub<Num, PowerList[HighestPowerOf2<Num>]>,
      BitOr<Acc, ExponentToBase2[HighestPowerOf2<Num>]>
    >;

type _Base2To10<
  Base2 extends string[],
  Index extends number = 0,
  Acc extends number = 0
> = Base2[Index] extends undefined
  ? Acc
  : Base2[Index] extends "1"
  ? _Base2To10<Base2, Add<Index, 1>, Add<Acc, PowerList[Index]>>
  : _Base2To10<Base2, Add<Index, 1>, Acc>;

export type Base2To10<Base2 extends string> = _Base2To10<
  SplitStringIntoChars<ReverseString<Base2>>
>;

Test.checks([
  Test.check<Base10To2<12>, "1100", Test.Pass>(),
  Test.check<Base10To2<31>, "11111", Test.Pass>(),
  Test.check<Base10To2<5>, "101", Test.Pass>(),
  Test.check<Base10To2<0xaabb>, "1010101010111011", Test.Pass>(),
  Test.check<
    Base10To2<0xffffffff>,
    "11111111111111111111111111111111",
    Test.Pass
  >(),

  Test.check<Base2To10<"1100">, 12, Test.Pass>(),
  Test.check<Base2To10<"11111">, 31, Test.Pass>(),
  Test.check<Base2To10<"101">, 5, Test.Pass>(),
  Test.check<
    Base2To10<"11111111111111111111111111111111">,
    0xffffffff,
    Test.Pass
  >(),
]);
